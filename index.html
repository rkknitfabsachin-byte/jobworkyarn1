<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Yarn Reco Dashboard â€” RK KNIT FAB</title>
<style>
  :root{
    --bg: #0a0f1e;
    --glass: rgba(255,255,255,0.08);
    --text: #eaf1ff;
    --muted: #b5c0db;
    --ok: #7ae582;
    --bad: #ff8b8b;
    --accent: #8ab4ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(900px 500px at 0% -10%, rgba(138,180,255,0.18), transparent),
      radial-gradient(900px 500px at 110% 0%, rgba(122,229,130,0.12), transparent),
      var(--bg);
  }
  .nav{position:sticky; top:0; z-index:10; display:flex; gap:10px; align-items:center; padding:12px 16px;
       background:linear-gradient(180deg, rgba(9,12,22,.85), rgba(9,12,22,0)); backdrop-filter: blur(14px);
       border-bottom:1px solid rgba(255,255,255,0.06);}
  .brand{font-weight:800; letter-spacing:.3px}
  .input,.btn{
    background:var(--glass); color:var(--text); border:1px solid rgba(255,255,255,0.1);
    border-radius:12px; padding:10px 12px; outline:none;
  }
  .btn{cursor:pointer; transition: transform .08s ease;}
  .btn:hover{transform: translateY(-1px)}
  .right{margin-left:auto; display:flex; gap:8px; align-items:center}
  .grid{display:grid; gap:16px; padding:16px; grid-template-columns: repeat(12, 1fr);}
  .card{
    grid-column: span 3; background:var(--glass); border:1px solid rgba(255,255,255,0.08);
    border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:0 0 4px 0; font-size:13px; color:var(--muted); font-weight:600}
  .card .val{font-size:28px; font-weight:800}
  .tableWrap{grid-column:1/-1; background:var(--glass); border:1px solid rgba(255,255,255,0.08); border-radius:16px; overflow:auto;}
  table{width:100%; border-collapse:collapse; font-size:14px;}
  th,td{padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.07); text-align:right}
  th:first-child, td:first-child{ text-align:left; position:sticky; left:0; background:linear-gradient(90deg, rgba(255,255,255,0.06), transparent);}
  th{position:sticky; top:0; backdrop-filter: blur(14px); background:linear-gradient(180deg, rgba(20,24,35,.85), rgba(20,24,35,.6))}
  .ok{color:var(--ok)}
  .bad{color:var(--bad)}
  .footer{padding:10px 16px; color:var(--muted)}
  .rowActions{display:flex; gap:6px}
  /* Drawer */
  .drawer{position:fixed; right:16px; bottom:16px; width:380px; max-height:70vh; overflow:auto;
          background:var(--glass); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:12px; display:none;}
  .drawer h4{margin:6px}
  .adjItem{padding:8px; border:1px solid rgba(255,255,255,0.1); border-radius:12px; margin:6px}
  /* Modal */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45)}
  .modal.show{display:flex}
  .modalCard{width:min(520px,92vw); background:var(--glass); border:1px solid rgba(255,255,255,0.12);
             border-radius:16px; padding:16px; box-shadow:0 20px 80px rgba(0,0,0,.5)}
  .row{display:flex; gap:8px; margin-bottom:8px}
  .row .input{flex:1}
</style>
</head>
<body>
  <div class="nav">
    <div class="brand">ðŸ§µ Yarn Reco Dashboard</div>
    <div class="right">
      <label>Month</label>
      <input id="month" class="input" type="month" />
      <input id="search" class="input" placeholder="Search Party/Yarn" />
      <button id="refresh" class="btn">Refresh</button>
      <button id="toggleAdj" class="btn">Adjustments</button>
    </div>
  </div>

  <div class="grid">
    <div class="card"><h3>Total Parties</h3><div id="cParties" class="val">â€”</div></div>
    <div class="card"><h3>Total Yarns</h3><div id="cYarns" class="val">â€”</div></div>
    <div class="card"><h3>Total Closing (kg)</h3><div id="cClosing" class="val">â€”</div></div>
    <div class="card"><h3>Variance (auto adj total)</h3><div id="cVar" class="val">â€”</div></div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Party</th>
            <th>Yarn</th>
            <th>Sent</th>
            <th>Consumed</th>
            <th>Returns</th>
            <th>Adjusted</th>
            <th>Closing</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Live from Sheets â€¢ Consumption = <b>WEB APP INCOMING â†’ TOTAL</b> â€¢ Adjustments are logged to <b>ADJUSTMENTS</b>.</div>

  <!-- Drawer -->
  <div id="drawer" class="drawer">
    <h4>Recent Adjustments (selected month)</h4>
    <div id="adjList"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modalCard">
      <h3>Adjust Yarn</h3>
      <div class="row">
        <input id="mMonth" class="input" type="month" />
        <input id="mParty" class="input" placeholder="Party" />
      </div>
      <div class="row">
        <input id="mYarn" class="input" placeholder="Yarn" />
        <input id="mQty" class="input" type="number" step="0.01" placeholder="+/- Qty (kg)" />
      </div>
      <div class="row">
        <input id="mReason" class="input" placeholder="Reason (Wastage / Pending Fabric / Mix-up / Other)" />
      </div>
      <div class="row">
        <input id="mNote" class="input" placeholder="Note (optional)" />
        <input id="mUser" class="input" placeholder="Entered By" />
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button id="mCancel" class="btn">Cancel</button>
        <button id="mSave" class="btn">Save</button>
      </div>
    </div>
  </div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwjimzV5fz35V_ao-3u9um1yAqPe-doZcYCx5hAxUbgqyoB9H5zMfHEVZikHmmT6Bxv8w/exec';

const els = {
  month: document.getElementById('month'),
  search: document.getElementById('search'),
  refresh: document.getElementById('refresh'),
  tbody: document.getElementById('tbody'),
  cParties: document.getElementById('cParties'),
  cYarns: document.getElementById('cYarns'),
  cClosing: document.getElementById('cClosing'),
  cVar: document.getElementById('cVar'),
  drawer: document.getElementById('drawer'),
  adjList: document.getElementById('adjList'),
  toggleAdj: document.getElementById('toggleAdj'),
  modal: document.getElementById('modal'),
  mMonth: document.getElementById('mMonth'),
  mParty: document.getElementById('mParty'),
  mYarn: document.getElementById('mYarn'),
  mQty: document.getElementById('mQty'),
  mReason: document.getElementById('mReason'),
  mNote: document.getElementById('mNote'),
  mUser: document.getElementById('mUser'),
  mCancel: document.getElementById('mCancel'),
  mSave: document.getElementById('mSave')
};

function ymNow(){ return new Date().toISOString().slice(0,7); }
function n2(x){ return (x==null||isNaN(x)) ? 'â€”' : Number(x).toFixed(2); }

async function getJSON(u){ const r = await fetch(u); if(!r.ok) throw new Error('Net'); return await r.json(); }
async function postJSON(u,b){ const r = await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}); if(!r.ok) throw new Error('Net'); return await r.json(); }

function rowHTML(r, month){
  return `<tr>
    <td style="text-align:left">${r.Party}</td>
    <td style="text-align:left">${r.Yarn}</td>
    <td>${n2(r.Sent)}</td>
    <td>${n2(r.Consumed)}</td>
    <td>${n2(r.Returns)}</td>
    <td>${n2(r.Adjusted)}</td>
    <td><b>${n2(r.Closing)}</b></td>
    <td><button class="btn" onclick='openAdjust("${month}","${r.Party}","${r.Yarn}")'>Adjust</button></td>
  </tr>`;
}

let _cache = { rows:[], cards:{} };

async function loadSummary(){
  const month = els.month.value || ymNow();
  const data = await getJSON(`${API_URL}?fn=summary&month=${month}`);
  _cache = data;

  const q = (els.search.value||'').toLowerCase().trim();
  let rows = data.rows || [];
  if(q){
    rows = rows.filter(r => String(r.Party).toLowerCase().includes(q) || String(r.Yarn).toLowerCase().includes(q));
  }

  els.cParties.textContent = data.cards?.totalParties ?? 'â€”';
  els.cYarns.textContent = data.cards?.totalYarns ?? 'â€”';
  els.cClosing.textContent = n2(data.cards?.totalClosing);
  els.cVar.textContent = n2(rows.reduce((a,b)=>a+(b.Adjusted||0),0));

  els.tbody.innerHTML = rows.map(r => rowHTML(r, month)).join('');
}

async function loadAdjustments(){
  const month = els.month.value || ymNow();
  const list = await getJSON(`${API_URL}?fn=adjustments&month=${month}`);
  els.adjList.innerHTML = (list||[]).slice(-40).reverse().map(a=>{
    return `<div class="adjItem">
      <div><b>${a['Party']}</b> â€¢ ${a['Yarn']}</div>
      <div>Qty: <b>${n2(a['Qty'])}</b> â€¢ Reason: ${a['Reason']||'-'}</div>
      <div>By: ${a['EnteredBy']||'-'} â€¢ ${a['Timestamp']||''} â€¢ Month: ${a['Month']||''}</div>
    </div>`;
  }).join('');
}

function openAdjust(month, party, yarn){
  els.modal.classList.add('show');
  els.mMonth.value = month;
  els.mParty.value = party;
  els.mYarn.value = yarn;
  els.mQty.value = '';
  els.mReason.value = '';
  els.mNote.value = '';
}

function closeAdjust(){ els.modal.classList.remove('show'); }

async function saveAdjust(){
  const payload = {
    month: els.mMonth.value || (els.month.value || ymNow()),
    party: els.mParty.value.trim(),
    yarn: els.mYarn.value.trim(),
    qty: parseFloat(els.mQty.value||'0'),
    reason: els.mReason.value.trim(),
    note: els.mNote.value.trim(),
    enteredBy: els.mUser.value.trim()
  };
  if(!payload.party || !payload.yarn) { alert('Party & Yarn required'); return; }
  if(!payload.month) { alert('Month required'); return; }
  if(!payload.qty || isNaN(payload.qty)) { alert('Qty must be a number'); return; }

  const res = await postJSON(API_URL, { fn:'saveAdjustment', payload });
  if(res.ok){
    closeAdjust();
    await loadSummary();
    if(els.drawer.style.display==='block') await loadAdjustments();
  } else {
    alert('Error saving');
  }
}

els.month.value = ymNow();
els.refresh.addEventListener('click', loadSummary);
els.search.addEventListener('input', loadSummary);
els.toggleAdj.addEventListener('click', async ()=>{
  els.drawer.style.display = (els.drawer.style.display==='block') ? 'none' : 'block';
  if(els.drawer.style.display==='block') await loadAdjustments();
});
els.mCancel.addEventListener('click', closeAdjust);
els.mSave.addEventListener('click', saveAdjust);

loadSummary().catch(console.error);
</script>
</body>
</html>
