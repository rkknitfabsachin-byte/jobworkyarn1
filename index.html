<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RK KNIT FAB — Yarn Reco Dashboard (Mobile First)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b0f19; --glass:rgba(255,255,255,.08);
    --text:#eaf1ff; --muted:#b8c3de; --accent:#8ab4ff;
    --border:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text); font-family:Inter, system-ui;
    background:var(--bg);
  }

  /* TOP BAR */
  .topbar{
    padding:12px; position:sticky; top:0; z-index:10;
    background:rgba(10,14,25,0.8); backdrop-filter: blur(14px);
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .input, .btn, select{
    flex:1; min-width:120px;
    padding:10px; border-radius:10px;
    border:1px solid var(--border);
    background:var(--glass); color:var(--text);
  }
  .btn{cursor:pointer; font-weight:600;}

  .section{padding:10px}
  .card{
    background:var(--glass); border:1px solid var(--border);
    padding:12px; border-radius:14px; margin-bottom:12px;
  }
  .kpi{
    display:flex; justify-content:space-between;
    font-size:18px; font-weight:700; margin:6px 0;
  }

  /* TABLE */
  table{
    width:100%; border-collapse:collapse; font-size:14px; margin-top:10px;
  }
  th,td{
    padding:10px 6px; border-bottom:1px solid var(--border);
    text-align:center;
  }
  th{
    background:rgba(20,24,35,0.7);
    position:sticky; top:0;
    backdrop-filter:blur(10px)
  }

  /* CHARTS */
  .chartBox{
    background:var(--glass); border:1px solid var(--border);
    padding:12px; border-radius:14px; margin-bottom:12px;
  }

  /* DRAWER (bottom sheet) */
  .drawer{
    position:fixed; bottom:0; left:0; right:0;
    max-height:70%; overflow:auto;
    background:rgba(15,20,30,.95);
    padding:16px;
    border-radius:18px 18px 0 0;
    display:none;
  }
  .adjItem{
    padding:10px; background:rgba(255,255,255,.06);
    border:1px solid var(--border); border-radius:12px;
    margin-bottom:10px;
  }

  /* MODAL */
  .modal{
    position:fixed; inset:0; display:none;
    align-items:center; justify-content:center;
    background:rgba(0,0,0,0.6);
  }
  .modalCard{
    width:92%; max-width:400px;
    background:var(--glass);
    border-radius:16px; border:1px solid var(--border);
    padding:18px;
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <input id="search" class="input" placeholder="Search Party/Yarn" />
  <input id="start" type="month" class="input" />
  <input id="end" type="month" class="input" />
  <button id="refresh" class="btn">Load</button>
  <button id="openDrawer" class="btn">Adjustments</button>
</div>

<!-- KPI CARDS -->
<div class="section">
  <div class="card"><div class="kpi"><span>Parties</span><span id="kParties">—</span></div></div>
  <div class="card"><div class="kpi"><span>Yarns</span><span id="kYarns">—</span></div></div>
  <div class="card"><div class="kpi"><span>Closing (kg)</span><span id="kClosing">—</span></div></div>
  <div class="card"><div class="kpi"><span>Adjustments</span><span id="kAdj">—</span></div></div>
</div>

<!-- FILTERS -->
<div class="section">
  <div class="card">
    <label>Party</label>
    <select id="fParty" class="input"></select>

    <label>Yarn</label>
    <select id="fYarn" class="input"></select>
  </div>
</div>

<!-- TABLE -->
<div class="section card">
  <table>
    <thead>
      <tr>
        <th>Party</th>
        <th>Yarn</th>
        <th>Sent</th>
        <th>Cons.</th>
        <th>Return</th>
        <th>Adj.</th>
        <th>Closing</th>
        <th>Act</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- CHARTS -->
<div class="section">
  <div class="chartBox"><canvas id="c1"></canvas></div>
  <div class="chartBox"><canvas id="c2"></canvas></div>
  <div class="chartBox"><canvas id="c3"></canvas></div>
  <div class="chartBox"><canvas id="c4"></canvas></div>
</div>

<!-- ADJUSTMENTS DRAWER -->
<div id="drawer" class="drawer">
  <h3>Recent Adjustments</h3>
  <div id="adjList"></div>
</div>

<!-- ADJUST MODAL -->
<div id="modal" class="modal">
  <div class="modalCard">
    <h3>Adjust Yarn</h3>
    <input id="mMonth" type="month" class="input" />
    <input id="mParty" class="input" placeholder="Party" />
    <input id="mYarn" class="input" placeholder="Yarn" />
    <input id="mQty" class="input" type="number" placeholder="+/- Qty (kg)" />
    <input id="mReason" class="input" placeholder="Reason" />
    <input id="mUser" class="input" placeholder="Entered By" />
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button id="mCancel" class="btn">Cancel</button>
      <button id="mSave" class="btn">Save</button>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwjimzV5fz35V_ao-3u9um1yAqPe-doZcYCx5hAxUbgqyoB9H5zMfHEVZikHmmT6Bxv8w/exec";

const E = id => document.getElementById(id);
let cache = { end:{rows:[]}, prev:{rows:[]}, range:[] };

async function getJSON(u){ const r = await fetch(u); return await r.json(); }
async function postJSON(u,b){ const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}); return await r.json(); }

function ymNow(){ return new Date().toISOString().slice(0,7); }
function prevMonth(ym){ const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-2,1); return d.toISOString().slice(0,7);}
function n2(x){ return isNaN(x)?'—':Number(x).toFixed(2); }

async function loadRange(){
  const end = E('end').value || ymNow();
  const start = E('start').value || end;
  const prev = prevMonth(start);

  const [endData, prevData] = await Promise.all([
    getJSON(`${API_URL}?fn=summary&month=${end}`),
    getJSON(`${API_URL}?fn=summary&month=${prev}`)
  ]);

  cache.end = endData;
  cache.prev = prevData;

  const mapPrev = new Map(prevData.rows.map(r=>[`${r.Party}||${r.Yarn}`,r]));

  cache.range = endData.rows.map(r=>{
    let p = mapPrev.get(`${r.Party}||${r.Yarn}`) || {Sent:0,Consumed:0,Returns:0,Adjusted:0};
    return {
      Party:r.Party,
      Yarn:r.Yarn,
      Sent:r.Sent - p.Sent,
      Consumed:r.Consumed - p.Consumed,
      Returns:r.Returns - p.Returns,
      Adjusted:r.Adjusted - p.Adjusted,
      Closing:r.Closing
    };
  });

  render();
  loadAdjustments();
}

function render(){
  const rows = cache.range;

  let parties = [...new Set(rows.map(r=>r.Party))].sort();
  let yarns = [...new Set(rows.map(r=>r.Yarn))].sort();

  E('fParty').innerHTML = '<option>(All)</option>' + parties.map(p=>`<option>${p}</option>`).join('');
  E('fYarn').innerHTML = '<option>(All)</option>' + yarns.map(y=>`<option>${y}</option>`).join('');

  renderTable();
  renderKPIs(rows);
  buildCharts(rows);
}

function filteredRows(){
  const q = (E('search').value||'').toLowerCase();
  const fp = E('fParty').value;
  const fy = E('fYarn').value;

  return cache.range.filter(r=>{
    const hit = !q || r.Party.toLowerCase().includes(q) || r.Yarn.toLowerCase().includes(q);
    const pOk = fp==='(All)' || r.Party===fp;
    const yOk = fy==='(All)' || r.Yarn===fy;
    return hit && pOk && yOk;
  });
}

function renderTable(){
  const rows = filteredRows();
  E('tbody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.Party}</td>
      <td>${r.Yarn}</td>
      <td>${n2(r.Sent)}</td>
      <td>${n2(r.Consumed)}</td>
      <td>${n2(r.Returns)}</td>
      <td>${n2(r.Adjusted)}</td>
      <td><b>${n2(r.Closing)}</b></td>
      <td><button class='btn' onclick='openAdjust("${E('end').value}","${r.Party}","${r.Yarn}")'>+</button></td>
    </tr>`).join('');
}

function renderKPIs(rows){
  E('kParties').textContent = new Set(rows.map(r=>r.Party)).size;
  E('kYarns').textContent   = new Set(rows.map(r=>r.Yarn)).size;
  E('kClosing').textContent = n2(rows.reduce((a,b)=>a+b.Closing,0));
  E('kAdj').textContent     = n2(rows.reduce((a,b)=>a+b.Adjusted,0));
}

let C={}; function kill(){for(let k in C)try{C[k].destroy()}catch(e){} }

function buildCharts(rows){
  kill();
  const ctx1=E('c1').getContext('2d');
  const ctx2=E('c2').getContext('2d');
  const ctx3=E('c3').getContext('2d');
  const ctx4=E('c4').getContext('2d');

  const byYarn={}; rows.forEach(r=>{byYarn[r.Yarn]=(byYarn[r.Yarn]||0)+r.Closing});
  const byParty={}; rows.forEach(r=>{byParty[r.Party]=(byParty[r.Party]||0)+r.Closing});
  const sent={}, cons={};
  rows.forEach(r=>{sent[r.Yarn]=(sent[r.Yarn]||0)+r.Sent; cons[r.Yarn]=(cons[r.Yarn]||0)+r.Consumed;});

  C.c1=new Chart(ctx1,{type:'bar',data:{labels:Object.keys(byYarn),datasets:[{label:'Closing',data:Object.values(byYarn)}]}});
  C.c2=new Chart(ctx2,{type:'bar',data:{labels:Object.keys(byParty),datasets:[{label:'Closing',data:Object.values(byParty)}]}});
  C.c3=new Chart(ctx3,{type:'bar',data:{labels:Object.keys(sent),
           datasets:[{label:'Sent',data:Object.values(sent)},{label:'Consumed',data:Object.values(cons)}] }});
  C.c4=new Chart(ctx4,{type:'doughnut',
           data:{labels:Object.keys(byYarn),datasets:[{label:'Yarn Mix',data:Object.values(byYarn)}]}});
}

async function loadAdjustments(){
  const end = E('end').value || ymNow();
  const list = await getJSON(`${API_URL}?fn=adjustments&month=${end}`);
  E('adjList').innerHTML = (list||[]).slice(-40).reverse().map(a=>`
    <div class='adjItem'>
      <div><b>${a['Party']}</b> • ${a['Yarn']}</div>
      <div>Qty: <b>${n2(a['Qty'])}</b> • ${a['Reason']||''}</div>
      <div>${a['EnteredBy']||''} — ${a['Timestamp']||''}</div>
    </div>`).join('');
}

function openAdjust(month,party,yarn){
  E('modal').style.display='flex';
  E('mMonth').value = month;
  E('mParty').value = party;
  E('mYarn').value = yarn;
  E('mQty').value = '';
  E('mReason').value = '';
}

function closeAdjust(){ E('modal').style.display='none'; }

async function saveAdjust(){
  const payload = {
    month: E('mMonth').value,
    party: E('mParty').value,
    yarn: E('mYarn').value,
    qty: parseFloat(E('mQty').value||'0'),
    reason: E('mReason').value,
    note: '',
    enteredBy: E('mUser').value
  };
  await postJSON(API_URL,{fn:'saveAdjustment',payload});
  closeAdjust();
  loadRange();
}

E('refresh').addEventListener('click',loadRange);
E('openDrawer').addEventListener('click',()=>{E('drawer').style.display='block'});
E('search').addEventListener('input',renderTable);
E('fParty').addEventListener('change',renderTable);
E('fYarn').addEventListener('change',renderTable);
E('mCancel').addEventListener('click',closeAdjust);
E('mSave').addEventListener('click',saveAdjust);

(function init(){
  const now=ymNow();
  E('start').value = now;
  E('end').value = now;
  loadRange();
})();
</script>
</body>
</html>
